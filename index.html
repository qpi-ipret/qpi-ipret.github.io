<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta property="og:image" content="https://qpi-ipret.github.io/reserve/cnsh.png" />
  <title>충남과학고 스터디 카페 예약</title>
  <link rel="icon" href="logo.ico" type="image/x-icon" />

  <!-- Pretendard Variable -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" />

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["Pretendard Variable", "system-ui", "-apple-system", "Segoe UI", "Roboto", "Helvetica", "Arial", "sans-serif"],
          },
          colors: {
            brand: {
              50: "#f1f6ff",
              100: "#e5efff",
              200: "#cfe2ff",
              500: "#234C93",
              600: "#1f417e",
              900: "#0f2242",
            },
          },
          boxShadow: {
            soft: "0 10px 30px rgb(0 0 0 / 0.06)",
          },
          borderRadius: {
            blob: "42px",
          },
          keyframes: {
            fadeUp: { "0%": { opacity: 0, transform: "translateY(8px)" }, "100%": { opacity: 1, transform: "translateY(0)" } },
            shimmer: { "100%": { transform: "translateX(100%)" } },
          },
          animation: {
            fadeUp: "fadeUp 400ms ease-out",
            shimmer: "shimmer 1.2s linear infinite",
          },
        },
      },
    };
  </script>

  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel for in-browser JSX transform -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    html, body { background: white; }
    /* Nice selection color */
    ::selection { background: #e5efff; color: #0f2242; }
  </style>
</head>
<body class="font-sans antialiased text-neutral-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;
    const URL = "https://script.google.com/macros/s/AKfycbyvr2pZewF0TE2QnJUKbbK94q-FrrESmsRoqZXcxVQRQVk94zToCJh8nceJuZHBJDkzZA/exec"; // version 13

    function getSeoulNow() {
      return new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
    }

    function formatYMD(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const da = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${da}`;
    }

    const MaskId = (id) => id.length <= 2 ? id : `${id.slice(0, 2)}••••`;

    function Badge({ tone = "green", children }) {
      const tones = {
        green: "border-green-600/20 bg-green-50 text-green-700",
        red: "border-red-600/20 bg-red-50 text-red-700",
        amber: "border-amber-600/20 bg-amber-50 text-amber-700",
        gray: "border-neutral-300 bg-white text-neutral-700",
        blue: "border-brand-500/20 bg-brand-50 text-brand-600",
      };
      return (
        <span className={`inline-flex items-center gap-1.5 rounded-full border px-2.5 py-1 text-sm ${tones[tone]}`}>{children}</span>
      );
    }

    function CapacityMeter({ current, capacity }) {
      const fill = Math.min(100, Math.round((current / capacity) * 100));
      return (
        <div className="w-full">
          <div className="flex items-center justify-between text-sm text-neutral-600 mb-1">
            <span>예약 현황</span>
            <span>{current}/{capacity}</span>
          </div>
          <div className="relative h-3 w-full overflow-hidden rounded-full bg-neutral-100">
            <div
              className="absolute inset-y-0 left-0 rounded-full bg-brand-500 transition-[width] duration-500"
              style={{ width: `${fill}%` }}
            />
            <div className="absolute inset-0 -translate-x-full animate-shimmer bg-gradient-to-r from-transparent via-white/40 to-transparent" />
          </div>
        </div>
      );
    }

    function StudyCafeReservation() {
      const [now, setNow] = useState(getSeoulNow());
      useEffect(() => { const t = setInterval(() => setNow(getSeoulNow()), 1000); return () => clearInterval(t); }, []);

      // 고정 오픈 (요청사항 반영). 시간 기반 제어 원하면 isOpen 계산으로 교체 가능.
      const isOpen = true;

      const [listLoading, setListLoading] = useState(true);
      const [list, setList] = useState([]);
      const [fetchErr, setFetchErr] = useState("");

      useEffect(() => {
        async function load() {
          setFetchErr("");
          try {
            const res = await fetch(URL, { method: "GET" });
            const txt = await res.text();
            const arr = JSON.parse(txt).map((e) => ({ studentId: e[0], name: e[1], date: new Date(e[3]) }));
            setList(arr);
          } catch (e) {
            setFetchErr("데이터를 불러오지 못했습니다. 새로고침해주세요.");
          } finally {
            setListLoading(false);
          }
        }
        load();
      }, []);

      const capacity = 15;
      const remaining = Math.max(0, capacity - list.length);

      const [studentId, setStudentId] = useState("");
      const [name, setName] = useState("");
      const [status, setStatus] = useState({ type: "idle", msg: "" }); // idle | error | ok | loading

      async function handleReserve(e) {
        e.preventDefault();
        if (!isOpen) {
          setStatus({ type: "error", msg: "예약은 매일 13:20에 오픈됩니다." });
          return;
        }
        if (!studentId.trim() || !name.trim()) {
          setStatus({ type: "error", msg: "학번과 이름을 모두 입력해 주세요." });
          return;
        }
        if (!/^\d{2,}$/.test(studentId.trim())) {
          setStatus({ type: "error", msg: "학번은 2자리 이상의 숫자로 입력해 주세요." });
          return;
        }
        setStatus({ type: "loading", msg: "예약 요청을 보내는 중..." });

        try {
          const body = JSON.stringify({ studentId: studentId.trim(), name: name.trim() });
          const res = await fetch(URL, { method: "POST", headers: { "Content-Type": "text/plain;charset=utf-8" }, body });
          const txt = await res.text();

          if (txt.startsWith("fail")) {
            const msg = txt.substring(6).split("\n");
            const reason = msg[0] || "예약에 실패했습니다.";
            if (msg.length >= 2) {
              try { setList(JSON.parse(msg[1]).map((e) => ({ studentId: e[0], name: e[1], date: new Date(e[3]) }))); } catch {}
            }
            setStatus({ type: "error", msg: reason });
            return;
          }

          // 성공
          const updated = JSON.parse(txt).map((e) => ({ studentId: e[0], name: e[1], date: new Date(e[3]) }));
          setList(updated);
          setStudentId("");
          setName("");
          setStatus({ type: "ok", msg: "예약이 완료되었습니다! 오늘 야간 자율학습 시간에 이용 가능합니다." });
        } catch (error) {
          setStatus({ type: "error", msg: "네트워크 오류가 발생했습니다. 다시 시도해 주세요." });
        }
      }

      return (
        <div>
          {/* Top Bar */}
          <header className="sticky top-0 z-40 border-b border-neutral-200/70 bg-white/70 backdrop-blur supports-[backdrop-filter]:bg-white/50">
            <div className="mx-auto flex h-16 max-w-5xl items-center justify-between px-5">
              <div className="flex items-center gap-2">
                <div className="grid h-7 w-7 place-items-center rounded-full bg-gradient-to-br from-neutral-900 to-brand-500 text-white shadow-soft">
                  <span className="text-[10px] font-semibold">CN
                    <span className="opacity-80">SH</span>
                  </span>
                </div>
                <span className="text-sm tracking-tight text-neutral-700">충곽 스터디 카페 예약</span>
              </div>
              <div className="flex items-center gap-2 text-xs text-neutral-500">
                <span>Asia/Seoul</span>
                <span className="text-neutral-300">•</span>
                <span>매일 13:20 오픈</span>
              </div>
            </div>
          </header>

          {/* Hero */}
          <section className="mx-auto max-w-5xl px-5 pt-12 pb-8">
            <div className="flex flex-col items-start gap-5 animate-fadeUp">
              <h1 className="text-4xl font-bold leading-[1.1] tracking-tight md:text-6xl">
                충곽 <span className="rounded-xl bg-neutral-900 px-2 text-white">스터디 카페</span>
                <br className="hidden md:block" />
                <span className="mt-2 inline-block text-[0.9em] font-semibold text-neutral-700">1층 언어실습실에서 만나요.</span>
              </h1>
              <p className="text-lg font-medium text-neutral-600 md:text-xl">
                매일 13:20 선착순 <strong className="font-semibold text-neutral-900">15명</strong> 예약 · 당일 야간 자율학습시간 이용
              </p>
            </div>
          </section>

          {/* Card */}
          <main className="mx-auto max-w-5xl px-5 pb-20">
            <div className="rounded-blob border border-neutral-200 bg-white/70 p-6 shadow-soft backdrop-blur md:p-8">
              {/* Top row */}
              <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div className="space-y-1">
                  <div className="text-sm text-neutral-500">오늘 날짜</div>
                  <div className="text-2xl font-medium">{formatYMD(now)}</div>
                </div>

                <div className="flex items-center gap-2">
                  {listLoading ? (
                    <Badge tone="amber">
                      <span className="relative inline-flex h-3 w-3 overflow-hidden rounded-full bg-amber-300/60 align-middle">
                        <span className="absolute inset-0 animate-ping rounded-full bg-amber-400/70" />
                      </span>
                      가져오는 중
                    </Badge>
                  ) : remaining === 0 ? (
                    <Badge tone="red">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" className="-mt-px">
                        <path d="M12 9v4m0 4h.01M10.29 3.86L1.82 18a2 2 0 00.13 2.12A2 2 0 003.5 21h17a2 2 0 001.55-.79 2 2 0 00.13-2.12L13.71 3.86a2 2 0 00-3.42 0z" stroke="currentColor" strokeWidth="1.6" strokeLinecap="round" strokeLinejoin="round"/>
                      </svg>
                      예약 마감
                    </Badge>
                  ) : (
                    <Badge tone="green">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" className="-mt-px">
                        <path d="M20 7l-9 9-5-5" stroke="currentColor" strokeWidth="1.6" strokeLinecap="round" strokeLinejoin="round"/>
                      </svg>
                      예약 가능 {remaining}석 남음
                    </Badge>
                  )}
                </div>
              </div>

              {/* Meter */}
              <div className="mt-6">
                <CapacityMeter current={Math.min(capacity, capacity - remaining)} capacity={capacity} />
              </div>

              {/* Form & List */}
              <div className="mt-8 grid gap-8 md:grid-cols-5">
                {/* Form */}
                <form className="md:col-span-2 space-y-3" onSubmit={handleReserve}>
                  <label className="block text-sm font-medium text-neutral-700">학번</label>
                  <div className="group relative">
                    <input
                      className="w-full rounded-2xl border border-neutral-300 bg-white px-4 py-3 pe-10 outline-none transition placeholder:text-neutral-400 focus:border-brand-500 focus:ring-4 focus:ring-brand-200"
                      placeholder="예: 11"
                      inputMode="numeric"
                      value={studentId}
                      onChange={(e) => setStudentId(e.target.value.replace(/[^0-9]/g, ''))}
                    />
                    <span className="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400 group-focus-within:text-brand-500">#</span>
                  </div>

                  <label className="mt-4 block text-sm font-medium text-neutral-700">이름</label>
                  <div className="group relative">
                    <input
                      className="w-full rounded-2xl border border-neutral-300 bg-white px-4 py-3 pe-10 outline-none transition placeholder:text-neutral-400 focus:border-brand-500 focus:ring-4 focus:ring-brand-200"
                      placeholder="예: 김철수"
                      value={name}
                      onChange={(e) => setName(e.target.value)}
                    />
                    <span className="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400 group-focus-within:text-brand-500">🙂</span>
                  </div>

                  <button
                    type="submit"
                    disabled={status.type === "loading" || remaining === 0}
                    className="group mt-3 inline-flex w-full items-center justify-center gap-2 rounded-2xl bg-neutral-900 px-5 py-3 font-medium text-white shadow-soft transition active:scale-[0.99] disabled:cursor-not-allowed disabled:opacity-60 hover:bg-neutral-800"
                  >
                    {status.type === "loading" ? (
                      <>
                        <span className="inline-flex h-4 w-4 animate-spin rounded-full border-2 border-white/40 border-t-white" />
                        처리 중...
                      </>
                    ) : (
                      <>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" className="opacity-90 transition group-hover:translate-x-0.5">
                          <path d="M12 5v14m-7-7h14" stroke="currentColor" strokeWidth="1.6" strokeLinecap="round" />
                        </svg>
                        예약하기
                      </>
                    )}
                  </button>

                  {status.type === "error" && (
                    <p className="rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">{status.msg}</p>
                  )}
                  {status.type === "ok" && (
                    <p className="rounded-xl border border-green-200 bg-green-50 px-3 py-2 text-sm text-green-700">{status.msg}</p>
                  )}
                </form>

                {/* List */}
                <div className="md:col-span-3">
                  <div className="mb-2 flex items-center justify-between">
                    <h2 className="text-base font-semibold text-neutral-800">오늘의 예약자</h2>
                    {!listLoading && (
                      <span className="text-sm text-neutral-500">총 {list.length}명</span>
                    )}
                  </div>

                  <div className="overflow-hidden rounded-2xl border border-neutral-200">
                    {listLoading ? (
                      <div className="divide-y divide-neutral-200">
                        {[...Array(5)].map((_, i) => (
                          <div key={i} className="relative flex items-center justify-between px-4 py-3">
                            <div className="h-4 w-24 rounded bg-neutral-200/60"></div>
                            <div className="h-4 w-32 rounded bg-neutral-200/60"></div>
                            <div className="h-4 w-16 rounded bg-neutral-200/60"></div>
                            <span className="absolute inset-0 -translate-x-full animate-shimmer bg-gradient-to-r from-transparent via-white/60 to-transparent" />
                          </div>
                        ))}
                      </div>
                    ) : list.length === 0 ? (
                      <div className="px-4 py-12 text-center text-neutral-500">아직 예약이 없습니다. 첫 예약의 주인공이 되어주세요!</div>
                    ) : (
                      <ul className="divide-y divide-neutral-200">
                        {list.map((e, idx) => (
                          <li key={`${e.studentId}-${idx}`} className="flex items-center justify-between px-4 py-3 transition hover:bg-neutral-50">
                            <div className="flex items-center gap-3">
                              <span className="grid h-8 w-8 place-items-center rounded-full bg-brand-100 text-sm font-semibold text-brand-600">{idx + 1}</span>
                              <div>
                                <div className="font-medium">{e.name}</div>
                                <div className="text-xs text-neutral-500">{MaskId(e.studentId.toString())}</div>
                              </div>
                            </div>
                            <div className="text-sm text-neutral-500">{e.date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}</div>
                          </li>
                        ))}
                      </ul>
                    )}
                  </div>

                  {fetchErr && (
                    <p className="mt-3 rounded-xl border border-amber-200 bg-amber-50 px-3 py-2 text-sm text-amber-800">{fetchErr}</p>
                  )}
                </div>
              </div>
            </div>
          </main>

          {/* Footer */}
          <footer className="mx-auto max-w-5xl px-5 pb-10 text-center text-sm text-neutral-500">
            <p>© {new Date().getFullYear()} 충남과학고 스터디 카페 · 제작 도움: 예약 자동화·UI 개선</p>
          </footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<StudyCafeReservation />);
  </script>
</body>
</html>
