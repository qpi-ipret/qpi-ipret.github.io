<!DOCTYPE html>
<html lang="ko" class="dark:bg-[#232323]">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta property="og:image" content="https://qpi-ipret.github.io/reserve/cnsh.png">
  <title>충남과학고 스터디 카페 예약 사이트</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="logo.ico" type="image/x-icon">
  <link rel="icon" href="logo.ico" type="image/x-icon" media="(prefers-color-scheme: light)">
  <link rel="icon" href="logo-dark.ico" type="image/x-icon" media="(prefers-color-scheme: dark)"> 
  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel for in-browser JSX transform -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- JQuery + Google login -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css');
    html, body { background: white; }
    
    /* bugfix */
    #login-button * {
      justify-content: center;
      padding: 0;
    }


    #login {
      position: relative;
    }

    #login-mockup {
      display: none;
      transition: background-color 0.218s, border-color 0.218s;
      width: 40px;
      height: 40px;
      position: absolute;
      right: 0;
      top: 0;
      box-sizing: border-box;
      border: 1px solid #dadce0;
      border-radius: 4px;
      /*display: flex;*/
      align-items: center;
      justify-content: center;
    }
    #login-mockup:hover {
      border-color: #d2e3fc;
      background-color: rgba(66, 133, 244, .08)
    }
    .pfp {
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
    }
    .circle {
      mask-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAMAAABrrFhUAAAAIGNIUk0AAHomAACAhAAA+gAAAIDoAAB1MAAA6mAAADqYAAAXcJy6UTwAAAAHdElNRQfpCBcWJxDf+LnOAAAAAW9yTlQBz6J3mgAAAwBQTFRFIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMj////MDFs+QAAAP50Uk5TAAEC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');
      mask-size: contain;
    }
    .circle-green {
      --color-fg: oklch(72.3% 0.219 149.579);
      --color-bg: oklch(92.5% 0.084 155.995);
    }
    .circle-orange {
      --color-fg: oklch(70.5% 0.213 47.604);
      --color-bg: oklch(90.1% 0.076 70.697);
    }
    .circle-red {
      --color-fg: oklch(63.7% 0.237 25.331);
    }
    .circle-gray {
      --color-fg: oklch(70.8% 0 0);
    }
    .qpilogo {
      --qpi-color: #232323;
    }
    @media screen and (prefers-color-scheme: dark) {
      .circle-green {
        --color-bg: oklch(44.8% 0.119 151.328);
      }
      .circle-orange {
        --color-bg: oklch(47% 0.157 37.304);
      }
      .qpilogo {
        --qpi-color: #fafafa;
      }
    }
  </style>
</head>
<body>
  <main class="min-h-screen bg-white dark:bg-[#232323] text-neutral-900 dark:text-neutral-100" style="font-family: -apple-system, BlinkMacSystemFont, 'Pretendard Variable', 'SF Pro Text', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif">
    <header class="fixed w-full top-0 z-30 border-b border-neutral-200/60 dark:border-neutral-700/60 bg-white/70 dark:bg-[#232323]/70 backdrop-blur supports-[backdrop-filter]:bg-white/50">
      <div class="max-w-3xl mx-auto px-6 flex items-center justify-between h-16">
        <div class="flex items-center gap-2">
          <div class="w-6 h-6 rounded-full circle qpilogo" style="background: conic-gradient(var(--qpi-color) 0deg 138.46deg, #234C93 138.46deg 360deg)"></div>
          <span class="text-sm tracking-tight text-neutral-700 dark:text-neutral-200">충곽 스터디 카페 예약</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="inline-block text-xs text-neutral-500 dark:text-neutral-300">Asia/Seoul · 매일 13:20~18:20 오픈</div>
          <div class="inline-block" id="login">
            <div id="g_id_onload"
              data-client_id="1079132266010-4r209j6rtmohatvtf74cksqcq7cn4uv0.apps.googleusercontent.com"
              data-context="use"
              data-ux_mode="popup"
              data-callback="handleCredentialResponse"
              data-auto_prompt="false">
            </div>

            <div id="login-button" class="g_id_signin"
                data-type="icon"
                data-shape="rectangular"
                data-theme="outline"
                data-text="continue_with"
                data-size="large"
                data-width="200">
            </div>
            <div id="login-mockup">
              <img class="pfp" />
            </div>
          </div>
        </div>
      </div>
    </header>
    <div id="root"></div>
  </main>
  
  <script>
    var GOOGLE_SUB = null

    async function handleCredentialResponse(response) {
      const idToken = response.credential;
      const res = await fetch(AUTH_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ idToken })
      });

      const data = await res.json();
      if (!data.success) {
        console.error(`fail: ${JSON.stringify(data)}`);
        return;
      }
      $(".g_id_signin").css("visibility", "hidden");
      $("#login-mockup").css("display", "flex");
      $(".pfp").attr("src",data.payload.picture);
      GOOGLE_SUB = data.payload.sub;
    }
  </script>
  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;
    const URL = "https://script.google.com/macros/s/AKfycbz3JV-VrezkrUbchukBIPaW5zTnlk7k0vHL8PJ7eKw-3TDezoZniMkx47Oni-aecSWaZg/exec" // version 21
    const AUTH_URL = "https://script.google.com/macros/s/AKfycbxWWGQbwf7XTRf67T5MIqmL0WY0064-__165ukUr7cPn27NsFV9ipt7YJ3UIJagKZba9g/exec" // login version 2
    
    function StudyCafeReservation() {
      const getSeoulNow = () => new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
      const formatYMD = (d) => {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const da = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${da}`;
      };

      const [now, setNow] = useState(getSeoulNow());
      const closingTime = useMemo(() => {
        const d = getSeoulNow();
        d.setHours(18, 20, 0, 0); // 18:20 고정
        return d;
      }, [now]);
      const msUntilClose = Math.max(0, closingTime - now);

      const openingTime = useMemo(() => {
        const d = getSeoulNow();
        d.setHours(6, 20, 0, 0); // 13:20 고정
        if (msUntilClose===0) d.setDate(d.getDate() + 1);
        return d;
      }, [now]);
      const msUntilOpen = Math.max(0, openingTime - now);

      const isOpen = (msUntilOpen === 0 && msUntilClose !== 0);
      //const isOpen = true;

      useEffect(() => {
        const t = setInterval(() => setNow(getSeoulNow()), 1000);
        return () => clearInterval(t);
      }, []);

      const [listLoading, setListLoading] = useState(true);
      const [list, setList] = useState([]);

      const [reload, setReload] = useState(true);
      useEffect(() => {
        if (!reload) return;
        (async () => {
          try {
            return await fetch(URL, {
              method: "GET",
              redirect: "follow"
            }).then(response => response.text())
            .catch(error => console.error('Error:', error));
          } catch (e) {
            return [];
          }
        })().then((data) => {
          setList(JSON.parse(data).map((e) => ({studentId:e[0], name:e[1], date: new Date(e[3])})));
          setListLoading(false);
          console.log("init start")
        })
      }, [])

      const [studentId, setStudentId] = useState("");
      const [name, setName] = useState("");
      const [pw, setPW] = useState("");
      const [error, setError] = useState("");
      const [ok, setOk] = useState("");

      const capacity = 15;
      const remaining = Math.max(0, capacity - list.length);

      const handleReserve = (e) => {
        e.preventDefault();
        setError("");
        setOk("");
        
        if (!isOpen) {
          setError("예약은 매일 13:20에서 18:20까지 오픈됩니다.");
          return;
        }
        if (!studentId.trim() || !name.trim()) {
          setError("학번과 이름을 모두 입력해 주세요.");
          return;
        }
        if (!/^\d{2,}$/.test(studentId.trim())) {
          setError("학번은 2자리 이상의 숫자로 입력해 주세요.");
          return;
        }

        setError("예약 요청을 보냈습니다. 잠시 기다려 주세요...")
        
        const data = {
          studentId: studentId.trim(),
          name: name.trim(),
          pw: pw.trim()
        };
        
        setReload(false);
        fetch(URL, {
          method: "POST",
          redirect: "follow",
          headers: {
            "Content-Type": "text/plain;charset=utf-8",
          },
          body: JSON.stringify(data),
        }).then(response => response.text())
        .then(result => {
          setReload(true);
          if (result.startsWith("fail")) {
            let msg = result.substring(6).split("\n");
            setError(msg[0]); // fail: [실패사유]
            if (msg.length < 2) return;
            setList(JSON.parse(msg[1]).map((e) => ({studentId:e[0], name:e[1], date: new Date(e[3])})));
            return;
          }
          setList(JSON.parse(result).map((e) => ({studentId:e[0], name:e[1], date: new Date(e[3])})));
          setStudentId("");
          setName("");
          setPW("");
          setError("");
          setOk("예약이 완료되었습니다! 오늘 야간 자율학습 시간에 이용 가능합니다.");
        })
        .catch(error => console.error('Error:', error));
      }

      const handleDeletion = (key) => {
        let pw_input = prompt("비밀번호를 입력하세요.");
        if (pw_input==null) return;

        setError("취소 요청을 보냈습니다. 잠시 기다려 주세요...");
        setOk("");
        
        const data = {
          studentId: "DELETE",
          key: key,
          pw: pw_input.trim()
        };
        
        setReload(false);
        fetch(URL, {
          method: "POST",
          redirect: "follow",
          headers: {
            "Content-Type": "text/plain;charset=utf-8",
          },
          body: JSON.stringify(data),
        }).then(response => response.text())
        .then(result => {
          setReload(true);
          if (result.startsWith("fail")) {
            let msg = result.substring(6).split("\n");
            setError(msg[0]); // fail: [실패사유]
            if (msg.length < 2) return;
            setList(JSON.parse(msg[1]).map((e) => ({studentId:e[0], name:e[1], date: new Date(e[3])})));
            return;
          }
          setList(JSON.parse(result).map((e) => ({studentId:e[0], name:e[1], date: new Date(e[3])})));
          setError("");
          setOk("예약 취소가 완료되었습니다.");
        })
        .catch(error => console.error('Error:', error));
      }

      const maskId = (id) => (id.length <= 2 ? id : `${id.slice(0, 2)}••••`);
      const timeLeft = () => {
        const ms = msUntilOpen;
        const s = Math.floor(ms / 1000);
        const hh = String(Math.floor(s / 3600)).padStart(2, "0");
        const mm = String(Math.floor((s % 3600) / 60)).padStart(2, "0");
        const ss = String(s % 60).padStart(2, "0");
        return `${hh}:${mm}:${ss}`;
      };
      const timeLeftClosing = () => {
        const ms = msUntilClose;
        const s = Math.floor(ms / 1000);
        const hh = String(Math.floor(s / 3600)).padStart(2, "0");
        const mm = String(Math.floor((s % 3600) / 60)).padStart(2, "0");
        const ss = String(s % 60).padStart(2, "0");
        return `${hh}:${mm}:${ss}`;
      };

      const container = "max-w-3xl mx-auto px-6";
      const glass = "backdrop-blur-xl bg-white/70 dark:bg-[#232323]/70 border border-neutral-200 dark:border-neutral-700 rounded-[42px] shadow-lg";
      const btnBase = "rounded-[16px] px-5 py-3 font-medium transition disabled:opacity-50 disabled:cursor-not-allowed";
      const btnPrimary = btnBase + " bg-black text-white dark:bg-neutral-50 dark:text-neutral-950 hover:bg-black/90 hover:dark:bg-neutral-50/90 active:scale-[0.99]";
      const inputBase = "w-full rounded-[16px] border border-neutral-300 dark:border-neutral-600 px-4 py-3 focus:outline-none focus:ring-4 focus:ring-neutral-200 transition bg-white dark:bg-neutral-950";

      return (
        <div>
          <section className={container + " mt-16 pt-14 pb-10"}>
            <div className="flex flex-col items-start gap-6">
              <h1 className="text-4xl md:text-6xl leading-tight tracking-tight font-semibold">
                충곽 <span className="inline-block bg-black text-white dark:bg-neutral-50 dark:text-neutral-950 px-2 rounded-xl">스터디 카페</span>
                <br/> 1층 언어실습실에서 만나요.
              </h1>
              <p className="text-neutral-600 dark:text-neutral-300 text-lg md:text-xl font-semibold">
                매일 13:20~18:20 선착순 <strong>15명</strong> 예약 · 당일 야간 자율학습시간 이용
              </p>
            </div>
          </section>
          
          <section className={container + " pb-16"}>
            <div className={glass + " p-6 md:p-8"}>
              <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div className="space-y-1">
                  <div className="text-sm text-neutral-500 dark:text-neutral-300">오늘 날짜</div>
                  <div className="text-2xl font-medium">{formatYMD(now)}</div>
                </div>
                <div className="text-right">
                  {isOpen ? (
                    listLoading ? (
                      <div className="inline-flex items-center gap-1 rounded-full border border-orange-600/20 bg-orange-50 dark:bg-orange-950 pl-1 pr-2 py-1 text-orange-700 dark:text-orange-400 tabular-nums">
                        <div className="w-6 h-6 rounded-full circle circle-orange" style={{background: `conic-gradient(var(--color-fg) 0deg ${(1-msUntilClose/(5*3600000))*360}deg, var(--color-bg) ${(1-msUntilClose/(5*3600000))*360}deg 360deg)`}}/>
                        가져오는 중 / {timeLeftClosing()}
                      </div>
                    ) : (
                      remaining==0 ? (
                        <div className="inline-flex items-center gap-1 rounded-full border border-red-600/20 bg-red-50 dark:bg-red-950 pl-1 pr-2 py-1 text-red-700 dark:text-red-400 tabular-nums">
                          <div className="w-6 h-6 rounded-full circle circle-red" style={{backgroundColor: "var(--color-fg)"}}/>
                          예약 조기 마감
                        </div>
                      ) : (
                        <div className="inline-flex items-center gap-1 rounded-full border border-green-600/20 bg-green-50 dark:bg-green-950 pl-1 pr-2 py-1 text-green-700 dark:text-green-400 tabular-nums">
                          <div className="w-6 h-6 rounded-full circle circle-green" style={{background: `conic-gradient(var(--color-fg) 0deg ${(1-msUntilClose/(5*3600000))*360}deg, var(--color-bg) ${(1-msUntilClose/(5*3600000))*360}deg 360deg)`}}/>
                          예약 마감까지 {timeLeftClosing()}
                        </div>
                      )
                    )
                  ) : (
                    <div className="inline-flex items-center gap-1 rounded-full border border-neutral-300 bg-neutral-50 dark:bg-[#232323] pl-1 pr-2 py-1 text-neutral-700 dark:text-neutral-400 tabular-nums">
                      <div className="w-6 h-6 rounded-full circle circle-gray" style={{backgroundColor: "var(--color-fg)"}}/>
                      {`오픈까지 ${timeLeft()}`}
                    </div>
                  )}
                </div>
              </div>

              <div className="mt-4 w-full">
                <div className="flex items-center justify-between text-sm text-neutral-500 dark:text-neutral-300 mb-1">
                  <span>예약 현황</span>
                  {listLoading ? (
                      <span className="font-semibold">.../{capacity}</span>
                    ) : (
                      remaining==0 ? (
                        <span className="font-semibold">{capacity}/{capacity}(마감)</span>
                      ) : (
                        <span className="font-semibold">{capacity-remaining}/{capacity}</span>
                      )
                  )}
                </div>
                <div className="relative h-3 w-full overflow-hidden rounded-full bg-neutral-100 dark:bg-neutral-700">
                  {isOpen ? (
                    listLoading ? (
                      <div
                        className="absolute inset-y-0 left-0 rounded-full bg-orange-200 dark:bg-orange-500/25 transition-[width]"
                        style={{ width: `100%` }}
                      />
                    ) : (
                      remaining==0 ? (
                        <div
                          className="absolute inset-y-0 left-0 rounded-full bg-red-500 dark:bg-red-400 transition-[width,background-color] duration-500"
                          style={{ width: `100%` }}
                        />
                      ) : (
                        <div
                          className="absolute inset-y-0 left-0 rounded-full bg-green-500 dark:bg-green-400 transition-[width,background-color] duration-500"
                          style={{ width: `${Math.min(100, Math.round((1 - remaining / capacity) * 100))}%` }}
                        />
                      )
                    )
                  ) : (
                    listLoading ? (
                      <div
                        className="absolute inset-y-0 left-0 rounded-full bg-neutral-300 transition-[width] duration-500"
                        style={{ width: `100%` }}
                      />
                    ) : (
                      <div
                        className="absolute inset-y-0 left-0 rounded-full bg-neutral-500 transition-[width,background-color] duration-500"
                        style={{ width: `${Math.min(100, Math.round((1 - remaining / capacity) * 100))}%` }}
                      />
                    )
                  )}
                </div>
              </div>

              <form onSubmit={handleReserve} className="mt-4 grid grid-cols-1 md:grid-cols-4 gap-3">
                <input
                  className={inputBase}
                  type="text"
                  inputMode="numeric"
                  placeholder="학번"
                  value={studentId}
                  onChange={(e) => setStudentId(e.target.value)}
                  disabled={!isOpen || list.length >= capacity}
                  aria-label="학번"
                />
                <input
                  className={inputBase}
                  type="text"
                  placeholder="이름"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  disabled={!isOpen || list.length >= capacity}
                  aria-label="이름"
                />
                <input
                  className={inputBase}
                  type="text"
                  placeholder="비밀번호(취소용)"
                  value={pw}
                  onChange={(e) => setPW(e.target.value)}
                  disabled={!isOpen || list.length >= capacity}
                  aria-label="비밀번호(취소에 사용)"
                />
                <button
                  className={btnPrimary}
                  type="submit"
                  disabled={!isOpen || list.length >= capacity}
                >
                  예약하기
                </button>
              </form>

              {error && (
                <div className="mt-4 rounded-2xl border border-red-200 bg-red-50 dark:border-red-700 dark:bg-red-950 px-4 py-3 text-red-700 dark:text-red-400 text-sm">{error}</div>
              )}
              {ok && (
                <div className="mt-4 rounded-2xl border border-emerald-200 bg-emerald-50 dark:border-emerald-700 dark:bg-emerald-950 px-4 py-3 text-emerald-700 dark:text-emerald-400 text-sm">{ok}</div>
              )}
              
              <div className="mt-10">
                <div className="flex items-end justify-between">
                  <h2 className="text-xl font-semibold tracking-tight">오늘의 예약 명단</h2>
                  <div className="text-xs text-neutral-500 dark:text-neutral-300">선착순 정렬 (최대 15명)</div>
                </div>
                {listLoading ? (
                  <ol className="mt-4 divide-y divide-neutral-200 dark:divide-neutral-700 border border-neutral-200 dark:border-neutral-700 rounded-2xl overflow-hidden">
                      <li className="p-4 text-neutral-500 dark:text-neutral-300 text-sm">로딩중</li>
                  </ol>
                ) : (
                  <ol className="mt-4 divide-y divide-neutral-200 dark:divide-neutral-700 border border-neutral-200 dark:border-neutral-700 rounded-2xl overflow-hidden">
                      {list.length === 0 && (
                        <li className="p-4 text-neutral-500 dark:text-neutral-300 text-sm">아직 예약이 없어요. 13:20에 오픈됩니다.</li>
                      )}
                      {list.toReversed().map((r, idx) => (
                        <li key={r.studentId} className="flex items-center justify-between p-4">
                          <div className="flex items-center gap-4">
                            <span className="inline-flex w-7 h-7 items-center justify-center rounded-full border border-neutral-300 dark:border-neutral-600 text-sm">
                              {list.length - idx}
                            </span>
                            <div>
                              <div className="font-medium">{r.name}</div>
                              <div className="text-xs text-neutral-500 dark:text-neutral-300">학번 {maskId(r.studentId.toString())}</div>
                            </div>
                          </div>
                          <div className="flex gap-2">
                            <button className="inline-block text-xs text-red-500 dark:text-red-600" onClick={() => handleDeletion(r.studentId)}>
                              취소
                            </button>
                            <div className="inline-block text-xs text-neutral-500 dark:text-neutral-300">
                              {new Date(r.date).toLocaleTimeString("ko-KR", { timeZone: "Asia/Seoul", hour: "2-digit", minute: "2-digit", second: "2-digit" })}
                            </div>
                          </div>
                        </li>
                      ))}
                  </ol>
                )}
              </div>
            </div>
          </section>

          <footer className="border-t border-neutral-200/60 dark:border-neutral-700/60">
            <div className={container + " py-10 text-sm text-neutral-500 flex flex-col md:flex-row gap-4 md:items-center md:justify-between"}>
              <div>© {now.getFullYear()} 충곽 스터디 카페 예약 MADE BY QPI</div>
              <div className="opacity-80">매일 13:20~18:20 오픈 · 당일 야간 자율학습 시간 이용 가능</div>
            </div>
          </footer>
        </div>
      );
    }
            
    const root = ReactDOM.createRoot(document.getElementById("root"));
          root.render(<StudyCafeReservation />);
  </script>
</body>
</html>